<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SNAKE EVO</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
:root{--sbg:#9bbc0f;--dark:#0f380f;--mid:#306230;--light:#8bac0f;}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{
  width:100%;min-height:100%;
  background:radial-gradient(ellipse at center,#16213e 0%,#0f0f23 100%);
  display:flex;justify-content:center;align-items:flex-start;
  font-family:'Press Start 2P',monospace;
  padding:16px 8px 32px;
}

/* â”€â”€ PHONE â”€â”€ */
.phone{
background:linear-gradient(145deg,#d4d4d4,#aaaaaa);
border-radius:28px 28px 50px 50px;
padding:14px 14px 22px;
box-shadow:0 20px 60px rgba(0,0,0,.9),
inset 0 2px 4px rgba(255,255,255,.5),
inset 0 -2px 4px rgba(0,0,0,.3);
width:310px;
display:flex;flex-direction:column;align-items:center;gap:7px;
}
.brand{color:#444;font-size:7px;letter-spacing:4px;}

/* â”€â”€ SCREEN â”€â”€ */
.screen-bezel{background:#111;border-radius:8px;padding:6px;
box-shadow:inset 0 3px 12px rgba(0,0,0,.95);width:100%;}
.screen{background:var(â€“sbg);border-radius:3px;position:relative;overflow:hidden;width:100%;}
.screen::before{content:â€™â€™;position:absolute;top:0;left:0;right:0;height:25%;
background:linear-gradient(to bottom,rgba(255,255,255,.07),transparent);
pointer-events:none;z-index:10;}
canvas{display:block;image-rendering:pixelated;width:100%;height:auto;}

/* HUD â€” always on top, never hidden */
.hud{display:flex;justify-content:space-between;align-items:center;
padding:3px 6px;background:var(â€“sbg);border-top:2px solid var(â€“mid);
position:relative;z-index:50;}
.hud span{font-size:6px;color:var(â€“dark);}
.hud-score{font-size:7px !important;}

/* Powerup bar */
.pu-bar{display:flex;gap:2px;padding:1px 4px;background:var(â€“sbg);
border-top:1px solid var(â€“mid);min-height:13px;align-items:center;}
.pu-chip{font-size:7px;padding:0 2px;border-radius:2px;
background:var(â€“dark);color:var(â€“sbg);line-height:1.4;}
.pu-chip em{font-size:4px;color:var(â€“light);font-style:normal;}

/* â”€â”€ OVERLAYS on green canvas â”€â”€ */
.overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:var(â€“sbg);
display:flex;flex-direction:column;align-items:center;justify-content:center;
gap:7px;z-index:20;padding:10px;}
.overlay.hidden{display:none;}
.ov-title{font-size:11px;color:var(â€“dark);text-align:center;line-height:1.8;}
.ov-sub{font-size:5.5px;color:var(â€“mid);text-align:center;line-height:2.2;animation:blink 1s infinite;}
.ov-info{font-size:6.5px;color:var(â€“dark);text-align:center;line-height:2;}
.ov-grade{font-size:20px;text-align:center;}
.ov-btn{background:var(â€“dark);color:var(â€“sbg);border:none;padding:4px 8px;
font-family:â€˜Press Start 2Pâ€™,monospace;font-size:5.5px;cursor:pointer;border-radius:3px;}
.ov-btn:hover{opacity:.8;}
.ov-btns{display:flex;gap:6px;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* Name entry overlay */
.name-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:var(â€“sbg);
display:flex;flex-direction:column;align-items:center;justify-content:center;
gap:10px;z-index:30;padding:10px;}
.name-overlay.hidden{display:none;}
.name-title{font-size:9px;color:var(â€“dark);text-align:center;line-height:2;}
.name-box{background:var(â€“dark);border-radius:4px;padding:6px 12px;min-width:150px;
text-align:center;font-size:12px;color:var(â€“sbg);letter-spacing:3px;
min-height:28px;display:flex;align-items:center;justify-content:center;}
.cursor{animation:blink .6s infinite;}
.name-hint{font-size:5px;color:var(â€“mid);text-align:center;line-height:2.2;}
#nameInput{opacity:0;position:fixed;top:50%;left:50%;width:1px;height:1px;
font-size:16px;border:none;outline:none;}

/* Level flash */
.lvl-flash{position:absolute;top:0;left:0;right:0;bottom:0;
background:rgba(15,56,15,.92);display:flex;flex-direction:column;
align-items:center;justify-content:center;gap:6px;z-index:25;pointer-events:none;}
.lvl-flash.hidden{display:none;}
.lf-title{font-size:12px;color:#9bbc0f;text-align:center;}
.lf-sub{font-size:5.5px;color:#8bac0f;text-align:center;line-height:2.2;}

/* â”€â”€ D-PAD â”€â”€ */
.dpad-wrap{
display:grid;
grid-template-areas:
â€˜. up .â€™
â€˜left center rightâ€™
â€˜. down .â€™;
grid-template-columns:auto auto auto;
grid-template-rows:auto auto auto;
grid-template-columns:var(â€“dpad-ah,60px) var(â€“dpad-w,88px) var(â€“dpad-ah,60px);
grid-template-rows:var(â€“dpad-ah,60px) var(â€“dpad-w,88px) var(â€“dpad-ah,60px);
gap:var(â€“dpad-gap,3px);
transition:gap .15s;
}
.btn{
background:linear-gradient(145deg,var(â€“btn-hi,#7a7a7a),var(â€“btn-lo,#4a4a4a));
border:none;cursor:pointer;
display:flex;align-items:center;justify-content:center;
color:var(â€“btn-arrow,#e0e0e0);
font-size:var(â€“arrow-fs,22px);
box-shadow:0 3px 7px rgba(0,0,0,.55),inset 0 1px rgba(255,255,255,.2);
transition:transform .08s,box-shadow .08s;
user-select:none;touch-action:manipulation;
-webkit-tap-highlight-color:transparent;
opacity:var(â€“btn-opacity,1);
}
.btn:active{transform:translateY(2px);box-shadow:0 1px 3px rgba(0,0,0,.4);}
.btn-up   {grid-area:up;   width:var(â€“dpad-w,88px);height:var(â€“dpad-ah,60px);border-radius:6px 6px 0 0;}
.btn-down {grid-area:down; width:var(â€“dpad-w,88px);height:var(â€“dpad-ah,60px);border-radius:0 0 6px 6px;}
.btn-left {grid-area:left; width:var(â€“dpad-ah,60px);height:var(â€“dpad-w,88px);border-radius:6px 0 0 6px;}
.btn-right{grid-area:right;width:var(â€“dpad-ah,60px);height:var(â€“dpad-w,88px);border-radius:0 6px 6px 0;}
.btn-center{
grid-area:center;width:var(â€“dpad-w,88px);height:var(â€“dpad-w,88px);
background:linear-gradient(145deg,#555,#333);
border-radius:50%;font-size:var(â€“ok-fs,6px);color:#bbb;padding:4px;line-height:1.4;
}

/* â”€â”€ ACTION BUTTONS â”€â”€ */
.action-row{display:flex;gap:12px;align-items:center;justify-content:center;width:100%;}
.action-btn{
background:linear-gradient(145deg,#666,#444);
border:none;border-radius:50%;
width:var(â€“act-sz,42px);height:var(â€“act-sz,42px);
cursor:pointer;color:#ccc;font-size:var(â€“act-fs,5.5px);
font-family:â€˜Press Start 2Pâ€™,monospace;
box-shadow:0 3px 7px rgba(0,0,0,.45);
transition:transform .08s;user-select:none;
touch-action:manipulation;-webkit-tap-highlight-color:transparent;
line-height:1.3;opacity:var(â€“btn-opacity,1);
}
.action-btn:active{transform:translateY(2px);}

/* â”€â”€ STATS STRIP â”€â”€ */
.stats-strip{background:rgba(0,0,0,.16);border-radius:7px;
padding:4px 8px;display:flex;justify-content:space-around;align-items:center;width:100%;}
.stat-item{display:flex;flex-direction:column;align-items:center;gap:1px;}
.stat-lbl{font-size:4px;color:#666;letter-spacing:1px;}
.stat-val{font-size:7px;color:#333;}
.live-dot{display:inline-block;width:5px;height:5px;background:#4a8a4a;
border-radius:50%;animation:pulse 1.2s infinite;margin-right:2px;vertical-align:middle;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(.5)}}

/* â”€â”€ PLAYER CHIP â”€â”€ */
.player-chip{background:rgba(0,0,0,.14);border-radius:7px;
padding:4px 10px;font-size:6.5px;color:#333;width:100%;text-align:center;}
.player-chip.hidden{display:none;}

/* â•â• INTRO OVERLAY â•â• */
.intro-ov{
position:absolute;top:0;left:0;right:0;bottom:0;
background:var(â€“sbg);
display:flex;flex-direction:column;align-items:center;justify-content:space-between;
z-index:40;padding:8px 8px 6px;overflow:hidden;
}
.intro-ov.hidden{display:none;}
.intro-slides{width:100%;flex:1;position:relative;overflow:hidden;}
.intro-slide{
position:absolute;top:0;left:0;right:0;bottom:0;
display:flex;flex-direction:column;align-items:center;justify-content:center;
gap:4px;padding:4px;
opacity:0;transform:translateX(100%);
transition:opacity .3s,transform .3s;pointer-events:none;
}
.intro-slide.active{opacity:1;transform:translateX(0);pointer-events:auto;}
.intro-slide.exit-left{opacity:0;transform:translateX(-100%);}
.intro-slide.exit-right{opacity:0;transform:translateX(100%);}
.is-heading{font-size:9px;color:var(â€“dark);text-align:center;line-height:1.9;margin-bottom:2px;}
.is-sub{font-size:5px;color:var(â€“mid);text-align:center;line-height:2;}
.is-row{width:100%;display:flex;align-items:center;gap:5px;
padding:3px 4px;border-bottom:1px solid rgba(15,56,15,.18);}
.is-icon{font-size:14px;min-width:22px;text-align:center;}
.is-text{font-size:4.8px;color:var(â€“dark);line-height:1.9;flex:1;}
.is-badge{font-size:5px;font-family:â€˜Press Start 2Pâ€™,monospace;
padding:2px 4px;border-radius:3px;white-space:nowrap;}
.intro-dots{display:flex;gap:5px;margin:3px 0;}
.intro-dot{width:5px;height:5px;border-radius:50%;background:var(â€“mid);
transition:background .2s,transform .2s;}
.intro-dot.on{background:var(â€“dark);transform:scale(1.3);}
.intro-nav{display:flex;gap:8px;width:100%;}
.intro-btn{flex:1;padding:5px;font-size:5px;font-family:â€˜Press Start 2Pâ€™,monospace;
border:none;border-radius:4px;cursor:pointer;background:var(â€“dark);color:var(â€“sbg);}
.intro-btn.skip{background:transparent;color:var(â€“mid);flex:0;padding:5px 8px;font-size:4.5px;}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SETTINGS PANEL â€” slides up over the
bottom half of the phone on pause
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.settings-panel{
width:100%;
background:linear-gradient(180deg,#1c1c30,#0e0e1e);
border-radius:12px 12px 0 0;
border-top:2px solid #2a3a6a;
padding:10px 12px 14px;
display:none; /* shown via .open */
flex-direction:column;gap:7px;
}
.settings-panel.open{display:flex;}

.sp-head{display:flex;justify-content:space-between;align-items:center;
border-bottom:1px solid #2a3a6a;padding-bottom:6px;}
.sp-title{font-size:7px;color:#4a90e2;letter-spacing:2px;}

.sp-hint{font-size:5px;color:#4a7abb;line-height:2;text-align:center;
border:1px dashed #2a3a6a;border-radius:4px;padding:4px;}

.sl-row{display:flex;align-items:center;gap:6px;}
.sl-lbl{font-size:5px;color:#8899bb;min-width:70px;}
.sl-val{font-size:5.5px;color:#e0f0ff;min-width:28px;text-align:right;}
input[type=range]{flex:1;height:4px;accent-color:#4a90e2;cursor:pointer;}
input[type=color]{width:32px;height:22px;border:none;cursor:pointer;
border-radius:3px;padding:0;}

.sp-btns{display:flex;gap:6px;margin-top:2px;}
.sp-btn{flex:1;padding:6px 2px;font-size:5.5px;font-family:â€˜Press Start 2Pâ€™,monospace;
border:none;border-radius:4px;cursor:pointer;text-align:center;}
.sp-reset{background:#3a1500;color:#ff9944;}
.sp-done {background:#0a2a0a;color:#8bc34a;}
</style>

</head>
<body>
<div class="phone" id="phone">
  <div class="brand">SNAKE EVO</div>

  <!-- SCREEN â€” HUD is part of the screen, always visible -->

  <div class="screen-bezel">
    <div class="screen">
      <!-- HUD locked at top of screen -->
      <div class="hud">
        <span id="hudLv">LV1</span>
        <span class="hud-score" id="scoreDisplay">000</span>
        <span id="hudPU"></span>
      </div>

```
  <!-- CANVAS -->
  <div style="position:relative">
    <canvas id="gameCanvas" width="282" height="188"></canvas>

    <!-- NAME ENTRY (on green screen) -->
    <div class="name-overlay" id="nameOverlay">
      <div class="name-title">ğŸ SNAKE EVO<br>ENTER YOUR NAME</div>
      <div class="name-box" id="nameBox"><span class="cursor">_</span></div>
      <input id="nameInput" type="text" maxlength="10"
        autocomplete="off" autocorrect="off" autocapitalize="characters"
        spellcheck="false" enterkeyhint="done"/>
      <div class="name-hint">TAP HERE Â· TYPE Â· PRESS RETURN</div>
    </div>

    <!-- GAME OVERLAY (welcome, game over, pause) -->
    <div class="overlay hidden" id="overlay">
      <div class="ov-title" id="ovTitle"></div>
      <div id="ovExtra"></div>
      <div class="ov-sub" id="ovSub"></div>
    </div>

    <!-- LEVEL FLASH -->
    <div class="lvl-flash hidden" id="lvlFlash">
      <div class="lf-title" id="lfTitle"></div>
      <div class="lf-sub"  id="lfSub"></div>
    </div>
  </div>


    <!-- INTRO SLIDESHOW -->
    <div class="intro-ov" id="introOv">
      <div class="intro-slides" id="introContent" style="width:100%;flex:1;overflow-y:auto;padding:2px 0;"></div>
      <div class="intro-dots" id="introDots">
        <div class="intro-dot on" ></div>
        <div class="intro-dot"></div>
        <div class="intro-dot"></div>
        <div class="intro-dot"></div>
        <div class="intro-dot"></div>
      </div>
      <div class="intro-nav">
        <button class="intro-btn skip" id="introSkip">SKIP</button>
        <button class="intro-btn" id="introPrev" style="opacity:0.3" disabled>PREV</button>
        <button class="intro-btn" id="introNext">NEXT ></button>
      </div>
    </div>

  <!-- POWERUP BAR below canvas, still inside screen -->
  <div class="pu-bar" id="puBar"></div>
</div>
```

  </div>

  <!-- D-PAD -->

  <div class="dpad-wrap" id="dpadWrap">
    <button class="btn btn-up"     id="btnUp">â–²</button>
    <button class="btn btn-left"   id="btnLeft">â—€</button>
    <button class="btn btn-center" id="btnCenter">OK</button>
    <button class="btn btn-right"  id="btnRight">â–¶</button>
    <button class="btn btn-down"   id="btnDown">â–¼</button>
  </div>

  <!-- START / PAUSE -->

  <div class="action-row">
    <button class="action-btn" id="btnStart">START</button>
    <button class="action-btn" id="btnPause">PAUSE</button>
  </div>

  <!-- STATS -->

  <div class="stats-strip">
    <div class="stat-item"><span class="stat-lbl">REGISTERED</span><span class="stat-val" id="statReg">0</span></div>
    <div class="stat-item"><span class="stat-lbl"><span class="live-dot"></span>ACTIVE</span><span class="stat-val" id="statActive">0</span></div>
    <div class="stat-item"><span class="stat-lbl">BEST SCORE</span><span class="stat-val" id="statBest">â€”</span></div>
  </div>
  <div class="player-chip hidden" id="playerChip"></div>

  <!-- SETTINGS PANEL (hidden until pause â†’ controller) -->

  <div class="settings-panel" id="settingsPanel">
    <div class="sp-head">
      <div class="sp-title">âš™ CONTROLLER</div>
    </div>
    <div class="sp-hint">ADJUST SLIDERS â€” BUTTONS UPDATE LIVE INSTANTLY</div>

```
<div class="sl-row">
  <span class="sl-lbl">D-PAD SIZE</span>
  <input type="range" id="slDpad" min="50" max="130" value="88">
  <span class="sl-val" id="slDpadV">88</span>
</div>
<div class="sl-row">
  <span class="sl-lbl">ACTION BTNS</span>
  <input type="range" id="slAct" min="30" max="72" value="42">
  <span class="sl-val" id="slActV">42</span>
</div>
<div class="sl-row">
  <span class="sl-lbl">ARROW SIZE</span>
  <input type="range" id="slFs" min="12" max="38" value="22">
  <span class="sl-val" id="slFsV">22</span>
</div>
<div class="sl-row">
  <span class="sl-lbl">BTN GAP</span>
  <input type="range" id="slGap" min="0" max="14" value="3">
  <span class="sl-val" id="slGapV">3</span>
</div>
<div class="sl-row">
  <span class="sl-lbl">OPACITY</span>
  <input type="range" id="slOp" min="20" max="100" value="100">
  <span class="sl-val" id="slOpV">100%</span>
</div>
<div class="sl-row">
  <span class="sl-lbl">BTN COLOR</span>
  <input type="color" id="colBtn" value="#555555">
  <span class="sl-val" id="colBtnV"></span>
</div>
<div class="sl-row">
  <span class="sl-lbl">ARROW COLOR</span>
  <input type="color" id="colArrow" value="#e0e0e0">
  <span class="sl-val" id="colArrowV"></span>
</div>

<div class="sp-btns">
  <button class="sp-btn sp-reset" id="spReset">â†º RESET</button>
  <button class="sp-btn sp-done"  id="spDone">âœ“ DONE â€” RESUME</button>
</div>
```

  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var PK='snkP', SK='snkS', CK='snkCtrl';
function ldP(){try{return JSON.parse(localStorage.getItem(PK))||{};}catch(e){return{};}}
function svP(d){try{localStorage.setItem(PK,JSON.stringify(d));}catch(e){}}
function ldS(){try{return JSON.parse(localStorage.getItem(SK))||null;}catch(e){return null;}}
function svS(s){try{localStorage.setItem(SK,JSON.stringify(s));}catch(e){}}
function clS(){try{localStorage.removeItem(SK);}catch(e){}}
function ldC(){try{return JSON.parse(localStorage.getItem(CK))||null;}catch(e){return null;}}
function svC(d){try{localStorage.setItem(CK,JSON.stringify(d));}catch(e){}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var canvas=document.getElementById('gameCanvas');
var ctx=canvas.getContext('2d');
var CELL=16;
var COLS=Math.floor(canvas.width/CELL);
var ROWS=Math.floor(canvas.height/CELL);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEVELS  (spd = ms per tick, higher = slower)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var LVS=[
  {pts:0,   spd:320,rocks:0,mov:0,bush:false,shrink:false,name:'LEVEL 1',feat:'OPEN FIELD'},
  {pts:80,  spd:275,rocks:3,mov:0,bush:false,shrink:false,name:'LEVEL 2',feat:'ROCKS APPEAR'},
  {pts:180, spd:235,rocks:3,mov:0,bush:true, shrink:false,name:'LEVEL 3',feat:'BUSH + GOLDEN PREY'},
  {pts:300, spd:195,rocks:4,mov:1,bush:true, shrink:false,name:'LEVEL 4',feat:'MOVING OBSTACLE'},
  {pts:450, spd:160,rocks:4,mov:1,bush:true, shrink:true, name:'LEVEL 5',feat:'BORDER SHRINKS'},
  {pts:630, spd:130,rocks:5,mov:2,bush:true, shrink:true, name:'LEVEL 6',feat:'SHIELD + GHOST + 2X'},
  {pts:840, spd:105,rocks:6,mov:3,bush:true, shrink:true, name:'LEVEL 7',feat:'3X MULTIPLIER'},
  {pts:1080,spd:85, rocks:7,mov:4,bush:true, shrink:true, name:'LEVEL 8',feat:'SURVIVAL MODE'}
];
function getLvI(sc){
  var i=0;
  for(var j=0;j<LVS.length;j++){if(sc>=LVS[j].pts)i=j;}
  return i;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var snake,dir,ndir,food,score,speed,lvI,lv;
var gl=null,running=false,paused=false,flash=false,lt=0;
var rocks=[],movers=[],border=0,shrinkT=0;
var golden=null,bush=null,hFood=null,bushRev=false;
var sPU=null,gPU=null,mPU=null;
var shOn=false,ghOn=false,ghMs=0,mN=1,mMs=0;
var lvF=0,lvD=0,lvG=0,grades=[];
var me=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTROLLER SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var DEFAULTS={dpad:88,act:42,fs:22,gap:3,op:100,btnColor:'#555555',arrowColor:'#e0e0e0'};
var cs={dpad:88,act:42,fs:22,gap:3,op:100,btnColor:'#555555',arrowColor:'#e0e0e0'};

function loadCtrlSettings(){
  var s=ldC();
  if(s){
    cs.dpad=s.dpad||88; cs.act=s.act||42; cs.fs=s.fs||22;
    cs.gap=s.gap||3; cs.op=s.op||100;
    cs.btnColor=s.btnColor||'#555555'; cs.arrowColor=s.arrowColor||'#e0e0e0';
  }
}
function saveCtrlSettings(){ svC(cs); }

function applyCtrl(){
  var root=document.documentElement;
  var ah=Math.round(cs.dpad*0.68);
  root.style.setProperty('--dpad-w',  cs.dpad+'px');
  root.style.setProperty('--dpad-ah', ah+'px');
  root.style.setProperty('--dpad-gap',cs.gap+'px');
  root.style.setProperty('--arrow-fs',cs.fs+'px');
  root.style.setProperty('--ok-fs',   Math.max(5,Math.round(cs.dpad*0.09))+'px');
  root.style.setProperty('--act-sz',  cs.act+'px');
  root.style.setProperty('--act-fs',  Math.max(4,Math.round(cs.act*0.14))+'px');
  root.style.setProperty('--btn-opacity', cs.op/100);
  var hi=lighten(cs.btnColor,28);
  root.style.setProperty('--btn-hi',    hi);
  root.style.setProperty('--btn-lo',    cs.btnColor);
  root.style.setProperty('--btn-arrow', cs.arrowColor);
}

function lighten(hex,amt){
  var n=parseInt(hex.replace('#',''),16);
  var r=Math.min(255,((n>>16)&0xff)+amt);
  var g=Math.min(255,((n>>8)&0xff)+amt);
  var b=Math.min(255,(n&0xff)+amt);
  function h2(x){var s=x.toString(16);return s.length<2?'0'+s:s;}
  return '#'+h2(r)+h2(g)+h2(b);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings(){
  document.getElementById('settingsPanel').classList.add('open');
  loadSliders();
}
function closeSettings(){
  saveCtrlSettings();
  document.getElementById('settingsPanel').classList.remove('open');
}
function loadSliders(){
  bindSl('slDpad','slDpadV',cs.dpad,'',  function(v){cs.dpad=+v;applyCtrl();});
  bindSl('slAct', 'slActV', cs.act, '',  function(v){cs.act=+v; applyCtrl();});
  bindSl('slFs',  'slFsV',  cs.fs,  '',  function(v){cs.fs=+v;  applyCtrl();});
  bindSl('slGap', 'slGapV', cs.gap, '',  function(v){cs.gap=+v; applyCtrl();});
  bindSl('slOp',  'slOpV',  cs.op,  '%', function(v){cs.op=+v;  applyCtrl();});
  bindCol('colBtn',  function(v){cs.btnColor=v;   applyCtrl();});
  bindCol('colArrow',function(v){cs.arrowColor=v; applyCtrl();});
}
function bindSl(id,vid,val,unit,cb){
  var el=document.getElementById(id);
  var vl=document.getElementById(vid);
  if(!el||!vl)return;
  el.value=val; vl.textContent=val+unit;
  el.oninput=function(){vl.textContent=el.value+unit; cb(el.value);};
}
function bindCol(id,cb){
  var el=document.getElementById(id);
  if(!el)return;
  el.oninput=function(){cb(el.value);};
}
document.getElementById('spReset').addEventListener('click',function(){
  cs={dpad:88,act:42,fs:22,gap:3,op:100,btnColor:'#555555',arrowColor:'#e0e0e0'};
  applyCtrl(); loadSliders();
});
document.getElementById('spDone').addEventListener('click',function(){
  closeSettings(); resumeFromPause();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAME ENTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var nameOverlay=document.getElementById('nameOverlay');
var nameBox    =document.getElementById('nameBox');
var nameInput  =document.getElementById('nameInput');
var typed='';

function showNameEntry(){
  document.getElementById('overlay').classList.add('hidden');
  document.getElementById('introOv').classList.add('hidden');
  nameOverlay.classList.remove('hidden');
  typed=''; nameInput.value=''; renderName();
  nameInput.focus();
  setTimeout(function(){nameInput.focus();},100);
  setTimeout(function(){nameInput.focus();},400);
}
function renderName(){
  nameBox.innerHTML=(typed||'')+'<span class="cursor">_</span>';
}
nameInput.addEventListener('input',function(){
  typed=nameInput.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
  nameInput.value=typed; renderName();
});
nameInput.addEventListener('keydown',function(e){
  if(e.key==='Enter'){e.preventDefault();confirmName();}
});
nameOverlay.addEventListener('click',function(){nameInput.focus();});

function confirmName(){
  var n=typed.trim(); if(!n){nameInput.focus();return;}
  var p=ldP();
  if(!p[n]) p[n]={name:n,best:0,active:true,lastSeen:Date.now()};
  else{p[n].active=true; p[n].lastSeen=Date.now();}
  svP(p); me=n;
  nameOverlay.classList.add('hidden');
  document.getElementById('playerChip').textContent='PLAYER: '+n;
  document.getElementById('playerChip').classList.remove('hidden');
  refreshStats(); checkSession();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshStats(){
  var p=ldP();
  var list=[];
  for(var k in p){if(p.hasOwnProperty(k))list.push(p[k]);}
  var now=Date.now();
  var active=0;
  var best=0;
  for(var i=0;i<list.length;i++){
    if(list[i].active&&now-(list[i].lastSeen||0)<15000)active++;
    if((list[i].best||0)>best)best=list[i].best||0;
  }
  document.getElementById('statReg').textContent=list.length||0;
  document.getElementById('statActive').textContent=active||0;
  document.getElementById('statBest').textContent=best||'-';
}
function setActive(n,v){
  if(!n)return; var p=ldP(); if(!p[n])return;
  p[n].active=v; p[n].lastSeen=Date.now(); svP(p);
}
function saveBest(n,sc){
  if(!n)return; var p=ldP(); if(!p[n])return;
  if(sc>(p[n].best||0)){p[n].best=sc; svP(p);}
}
setInterval(function(){if(me&&running)setActive(me,true);refreshStats();},5000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doSave(){
  if(!running||!me)return;
  var snap={
    who:me,
    snake:JSON.parse(JSON.stringify(snake)),
    dir:{x:dir.x,y:dir.y},
    ndir:{x:ndir.x,y:ndir.y},
    food:{x:food.x,y:food.y},
    score:score,speed:speed,lvI:lvI,
    rocks:JSON.parse(JSON.stringify(rocks)),
    border:border,ts:Date.now()
  };
  svS(snap);
}
setInterval(function(){if(running&&!paused)doSave();},2500);
window.addEventListener('beforeunload',doSave);
window.addEventListener('visibilitychange',function(){
  if(document.visibilityState==='hidden')doSave();
});

function checkSession(){
  var s=ldS();
  if(!s||s.who!==me){showHome();return;}
  var age=Date.now()-s.ts;
  var aStr=age<60000?Math.round(age/1000)+'s ago':Math.round(age/60000)+'m ago';
  showOv('WELCOME BACK!',
    '<div class="ov-info">SCORE '+s.score+' LV'+(s.lvI+1)+'</div>'+
    '<div style="font-size:5px;color:var(--mid);margin:2px 0">'+aStr+'</div>'+
    '<div class="ov-btns">'+
    '<button class="ov-btn" id="rvBtn">CONTINUE</button>'+
    '<button class="ov-btn" id="nwBtn">NEW GAME</button>'+
    '</div>','');
  setTimeout(function(){
    var rv=document.getElementById('rvBtn');
    var nw=document.getElementById('nwBtn');
    if(rv)rv.onclick=function(){resumeGame(s);};
    if(nw)nw.onclick=function(){clS();startFresh();};
  },50);
}
function resumeGame(s){
  snake=JSON.parse(JSON.stringify(s.snake));
  dir={x:s.dir.x,y:s.dir.y};
  ndir={x:s.ndir.x,y:s.ndir.y};
  food={x:s.food.x,y:s.food.y};
  score=s.score;speed=s.speed;lvI=s.lvI;lv=LVS[lvI];
  rocks=JSON.parse(JSON.stringify(s.rocks||[]));
  border=s.border||0;
  movers=[];golden=null;bush=null;hFood=null;bushRev=false;
  sPU=null;gPU=null;mPU=null;
  shOn=false;ghOn=false;ghMs=0;mN=1;mMs=0;
  paused=false;flash=false;
  updateScore();updateHUD();
  document.getElementById('overlay').classList.add('hidden');
  running=true;lt=Date.now();
  clearInterval(gl);gl=setInterval(tick,speed);
  setActive(me,true);refreshStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT / SPAWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initGame(){
  snake=[{x:9,y:6},{x:8,y:6},{x:7,y:6}];
  dir={x:1,y:0};ndir={x:1,y:0};
  score=0;lvI=0;lv=LVS[0];speed=lv.spd;
  border=0;rocks=[];movers=[];
  golden=null;bush=null;hFood=null;bushRev=false;
  sPU=null;gPU=null;mPU=null;
  shOn=false;ghOn=false;ghMs=0;mN=1;mMs=0;
  shrinkT=0;lvF=0;lvD=0;lvG=0;grades=[];
  paused=false;flash=false;
  spawnFood();updateScore();updateHUD();
}
function freeCell(){
  var p,t=0,ok;
  do{
    p={x:border+Math.floor(Math.random()*(COLS-border*2)),
       y:border+Math.floor(Math.random()*(ROWS-border*2))};
    ok=true;
    for(var i=0;i<snake.length;i++){if(snake[i].x===p.x&&snake[i].y===p.y){ok=false;break;}}
    if(food&&food.x===p.x&&food.y===p.y)ok=false;
    for(var i=0;i<rocks.length;i++){if(rocks[i].x===p.x&&rocks[i].y===p.y){ok=false;break;}}
    for(var i=0;i<movers.length;i++){if(movers[i].x===p.x&&movers[i].y===p.y){ok=false;break;}}
    if(golden&&golden.x===p.x&&golden.y===p.y)ok=false;
    if(bush&&bush.x===p.x&&bush.y===p.y)ok=false;
    if(sPU&&sPU.x===p.x&&sPU.y===p.y)ok=false;
    if(gPU&&gPU.x===p.x&&gPU.y===p.y)ok=false;
    if(mPU&&mPU.x===p.x&&mPU.y===p.y)ok=false;
    t++;
  }while(!ok&&t<300);
  return p;
}
function spawnFood(){food=freeCell();}
function spawnRocks(n){
  rocks=[];
  for(var i=0;i<n;i++)rocks.push(freeCell());
}
function spawnMovers(n){
  movers=[];
  var ds=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];
  for(var i=0;i<n;i++){
    var p=freeCell();
    var d=ds[Math.floor(Math.random()*4)];
    movers.push({x:p.x,y:p.y,dx:d.x,dy:d.y,t:0,iv:520+Math.random()*480});
  }
}
function spawnBush(){
  if(!lv.bush){bush=null;hFood=null;return;}
  bush=freeCell();hFood=freeCell();bushRev=false;
}
function tryGolden(){
  if(lvI<2||golden)return;
  if(Math.random()>0.55)golden={x:freeCell().x,y:freeCell().y,t:Date.now(),ttl:3000};
}
function tryPUs(){
  if(lvI<5)return;
  var fc;
  if(!sPU&&Math.random()>0.75){fc=freeCell();sPU={x:fc.x,y:fc.y,t:Date.now(),ttl:12000};}
  if(!gPU&&Math.random()>0.8) {fc=freeCell();gPU={x:fc.x,y:fc.y,t:Date.now(),ttl:12000};}
  if(!mPU&&Math.random()>0.85){
    fc=freeCell();
    var m=lvI>=6?3:2;
    mPU={x:fc.x,y:fc.y,t:Date.now(),ttl:lvI>=6?5000:10000,m:m};
  }
}
function setupLevel(){
  lv=LVS[lvI];speed=lv.spd;
  spawnRocks(lv.rocks);spawnMovers(lv.mov);
  spawnBush();shrinkT=Date.now();tryGolden();tryPUs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateScore(){
  var s=String(score);
  while(s.length<3)s='0'+s;
  document.getElementById('scoreDisplay').textContent=s;
}
function updateHUD(){
  document.getElementById('hudLv').textContent='LV'+(lvI+1);
  var b=[];
  if(shOn)b.push('SHIELD');
  if(ghOn)b.push('GHOST');
  if(mN>1)b.push(mN+'X');
  document.getElementById('hudPU').textContent=b.join(' ');
  var now=Date.now(),chips=[];
  if(shOn)chips.push('SHIELD');
  if(ghOn)chips.push('GHOST '+Math.ceil(ghMs/1000)+'s');
  if(mN>1)chips.push(mN+'x '+Math.ceil(mMs/1000)+'s');
  if(golden)chips.push('GOLD '+Math.max(0,Math.ceil((golden.ttl-(now-golden.t))/1000))+'s');
  var puHtml='';
  for(var ci=0;ci<chips.length;ci++){
    puHtml+='<span class="pu-chip">'+chips[ci]+'</span>';
  }
  document.getElementById('puBar').innerHTML=puHtml;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function draw(){
  var now=Date.now();
  ctx.fillStyle='#9bbc0f';ctx.fillRect(0,0,canvas.width,canvas.height);
  if(border>0){
    ctx.fillStyle='#0f380f';
    ctx.fillRect(0,0,canvas.width,border*CELL);
    ctx.fillRect(0,canvas.height-border*CELL,canvas.width,border*CELL);
    ctx.fillRect(0,0,border*CELL,canvas.height);
    ctx.fillRect(canvas.width-border*CELL,0,border*CELL,canvas.height);
  }
  ctx.fillStyle='#8bac0f';
  for(var x=border;x<COLS-border;x++){
    for(var y=border;y<ROWS-border;y++){
      ctx.fillRect(x*CELL+CELL/2-1,y*CELL+CELL/2-1,2,2);
    }
  }
  for(var ri=0;ri<rocks.length;ri++){
    var r=rocks[ri];
    ctx.fillStyle='#5a5a48';ctx.fillRect(r.x*CELL+1,r.y*CELL+1,CELL-2,CELL-2);
    ctx.fillStyle='#8a8a70';ctx.fillRect(r.x*CELL+3,r.y*CELL+3,5,3);
    ctx.fillStyle='#3a3a2c';ctx.fillRect(r.x*CELL+8,r.y*CELL+8,4,3);
  }
  for(var mi=0;mi<movers.length;mi++){
    var mv=movers[mi];
    ctx.fillStyle='#6b2200';ctx.fillRect(mv.x*CELL+1,mv.y*CELL+1,CELL-2,CELL-2);
    ctx.fillStyle='#bb4400';ctx.fillRect(mv.x*CELL+4,mv.y*CELL+4,CELL-8,CELL-8);
  }
  if(bush){
    ctx.fillStyle='#1a4a1a';ctx.fillRect(bush.x*CELL+1,bush.y*CELL+1,CELL-2,CELL-2);
    if(!bushRev){
      ctx.fillStyle='#2d7a2d';
      ctx.fillRect(bush.x*CELL+3,bush.y*CELL+2,CELL-6,4);
      ctx.fillRect(bush.x*CELL+2,bush.y*CELL+6,CELL-4,3);
    }
  }
  if(bushRev&&hFood){
    var p2=Math.floor(now/200)%2===0;
    ctx.fillStyle='#cc3300';ctx.fillRect(hFood.x*CELL+2,hFood.y*CELL+2,CELL-4,CELL-4);
    if(p2){ctx.fillStyle='#9bbc0f';ctx.fillRect(hFood.x*CELL+5,hFood.y*CELL+5,CELL-10,CELL-10);}
  }
  var p1=Math.floor(now/300)%2===0;
  ctx.fillStyle='#306230';ctx.fillRect(food.x*CELL+2,food.y*CELL+2,CELL-4,CELL-4);
  if(p1){ctx.fillStyle='#9bbc0f';ctx.fillRect(food.x*CELL+5,food.y*CELL+5,CELL-10,CELL-10);}
  if(golden&&now-golden.t<golden.ttl){
    var gp=Math.floor(now/130)%2===0;
    ctx.fillStyle=gp?'#ffcc00':'#ff9900';
    ctx.fillRect(golden.x*CELL+1,golden.y*CELL+1,CELL-2,CELL-2);
    ctx.fillStyle='#fff';ctx.fillRect(golden.x*CELL+5,golden.y*CELL+5,4,4);
  } else if(golden){golden=null;setTimeout(tryGolden,3500+Math.random()*2000);}

  function drawPU(pu,col,lbl){
    if(!pu||now-pu.t>pu.ttl)return;
    var pp=Math.floor(now/250)%2===0;
    ctx.fillStyle=pp?col:'#9bbc0f';
    ctx.fillRect(pu.x*CELL+1,pu.y*CELL+1,CELL-2,CELL-2);
    ctx.fillStyle='#0f380f';ctx.textAlign='center';
    ctx.font='bold 8px sans-serif';
    ctx.fillText(lbl,pu.x*CELL+CELL/2,pu.y*CELL+CELL/2+3);
  }
  drawPU(sPU,'#3399ff','S');
  drawPU(gPU,'#9999ff','G');
  if(mPU)drawPU(mPU,'#ffaa00',mPU.m+'x');

  for(var si=0;si<snake.length;si++){
    var seg=snake[si];
    if(ghOn)ctx.globalAlpha=0.45;
    ctx.fillStyle=(shOn&&si===0)?'#3399ff':(si===0?'#0f380f':'#306230');
    ctx.fillRect(seg.x*CELL+1,seg.y*CELL+1,CELL-2,CELL-2);
    if(si===0){
      ctx.fillStyle=ghOn?'rgba(200,200,255,0.9)':'#9bbc0f';
      var ax,ay,bx,by;
      if(dir.x===1)      {ax=CELL-5;ay=3;    bx=CELL-5;by=CELL-6;}
      else if(dir.x===-1){ax=2;    ay=3;    bx=2;    by=CELL-6;}
      else if(dir.y===-1){ax=3;    ay=2;    bx=CELL-6;by=2;}
      else               {ax=3;    ay=CELL-5;bx=CELL-6;by=CELL-5;}
      ctx.fillRect(seg.x*CELL+ax,seg.y*CELL+ay,2,2);
      ctx.fillRect(seg.x*CELL+bx,seg.y*CELL+by,2,2);
    }
    ctx.globalAlpha=1;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TICK / STEP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tick(){
  var now=Date.now(),dt=now-lt;lt=now;
  if(ghOn){ghMs=Math.max(0,ghMs-dt);if(!ghMs)ghOn=false;}
  if(mN>1){mMs=Math.max(0,mMs-dt);if(!mMs)mN=1;}
  if(sPU&&now-sPU.t>sPU.ttl)sPU=null;
  if(gPU&&now-gPU.t>gPU.ttl)gPU=null;
  if(mPU&&now-mPU.t>mPU.ttl)mPU=null;
  for(var mi=0;mi<movers.length;mi++){
    var mv=movers[mi];
    mv.t+=dt;
    if(mv.t>=mv.iv){
      mv.t=0;
      var nx=mv.x+mv.dx,ny=mv.y+mv.dy;
      var bl=nx<border||nx>=COLS-border||ny<border||ny>=ROWS-border;
      for(var ri=0;ri<rocks.length;ri++){if(rocks[ri].x===nx&&rocks[ri].y===ny)bl=true;}
      if(bl){mv.dx=-mv.dx;mv.dy=-mv.dy;}else{mv.x=nx;mv.y=ny;}
    }
  }
  if(lv.shrink&&now-shrinkT>25000){
    shrinkT=now;
    if(border<Math.min(COLS,ROWS)/2-3)border++;
  }
  if(!flash)step();
  draw();updateHUD();
}
function step(){
  dir={x:ndir.x,y:ndir.y};
  var h={x:snake[0].x+dir.x,y:snake[0].y+dir.y};
  if(h.x<border||h.x>=COLS-border||h.y<border||h.y>=ROWS-border){die();return;}
  for(var ri=0;ri<rocks.length;ri++){if(rocks[ri].x===h.x&&rocks[ri].y===h.y){die();return;}}
  for(var mi=0;mi<movers.length;mi++){if(movers[mi].x===h.x&&movers[mi].y===h.y){die();return;}}
  if(!ghOn){
    for(var si=1;si<snake.length;si++){if(snake[si].x===h.x&&snake[si].y===h.y){die();return;}}
  }
  snake.unshift(h);
  var grew=false;
  if(h.x===food.x&&h.y===food.y){
    score+=10*mN;grew=true;lvF++;
    spawnFood();chkLvUp();
    if(lvI>=2)tryGolden();tryPUs();
  } else if(golden&&h.x===golden.x&&h.y===golden.y){
    score+=50*mN;grew=true;lvG++;
    golden=null;setTimeout(tryGolden,4000+Math.random()*2000);
  } else if(bush&&h.x===bush.x&&h.y===bush.y){
    bushRev=true;
  } else if(bushRev&&hFood&&h.x===hFood.x&&h.y===hFood.y){
    score+=30*mN;grew=true;lvF++;
    bush=null;hFood=null;bushRev=false;chkLvUp();
    setTimeout(spawnBush,5000);
  } else if(sPU&&h.x===sPU.x&&h.y===sPU.y){shOn=true;sPU=null;
  } else if(gPU&&h.x===gPU.x&&h.y===gPU.y){ghOn=true;ghMs=5000;gPU=null;
  } else if(mPU&&h.x===mPU.x&&h.y===mPU.y){mN=mPU.m;mMs=mPU.m===3?8000:15000;mPU=null;}
  if(!grew)snake.pop();
  updateScore();
}
function die(){
  if(shOn){
    shOn=false;
    ctx.fillStyle='rgba(51,153,255,0.4)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    return;
  }
  lvD++;gameOver();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEVEL UP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function chkLvUp(){
  var ni=getLvI(score);
  if(ni<=lvI)return;
  var g=calcGrade();
  grades.push({lv:lvI+1,g:g});
  lvI=ni;lv=LVS[lvI];speed=lv.spd;
  lvF=0;lvD=0;lvG=0;
  spawnRocks(lv.rocks);spawnMovers(lv.mov);spawnBush();
  shrinkT=Date.now();tryGolden();tryPUs();
  doFlash(lv,g);
}
function calcGrade(){
  if(lvD===0&&lvG>0&&lvF>=4)return'S';
  if(lvD===0&&lvF>=3)return'A';
  if(lvD<=1&&lvF>=2)return'B';
  if(lvD<=2)return'C';
  return'D';
}
function gc(g){
  if(g==='S')return'#ffcc00';
  if(g==='A')return'#8bc34a';
  if(g==='B')return'#4a90e2';
  if(g==='C')return'#ff8800';
  return'#cc4444';
}
function doFlash(l,g){
  flash=true;
  clearInterval(gl);gl=null;
  var reward='';
  if(g==='S')reward='REWARD: GHOST MODE 20s';
  else if(g==='A')reward='REWARD: FREE SHIELD';
  else if(g==='B')reward='REWARD: 2X SCORE 30s';
  else if(g==='C')reward='REWARD: +50 BONUS PTS';
  else reward='NO REWARD - KEEP GOING!';
  document.getElementById('lfTitle').textContent=l.name;
  document.getElementById('lfSub').innerHTML=
    l.feat+'<br>'+
    '<span style="color:'+gc(g)+';font-size:20px">GRADE '+g+'</span><br>'+
    '<span style="font-size:6px;color:#ffcc00">'+reward+'</span>';
  document.getElementById('lvlFlash').classList.remove('hidden');
  setTimeout(function(){
    document.getElementById('lvlFlash').classList.add('hidden');
    flash=false;
    // Apply grade reward
    if(g==='S'){ghOn=true;ghMs=20000;}
    else if(g==='A'){shOn=true;}
    else if(g==='B'){mN=2;mMs=30000;}
    else if(g==='C'){score+=50;updateScore();}
    lt=Date.now();
    gl=setInterval(tick,speed);
  },3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startFresh(){
  if(!me){showNameEntry();return;}
  closeSettings();
  clearInterval(gl);
  initGame();clS();setupLevel();
  document.getElementById('overlay').classList.add('hidden');
  running=true;lt=Date.now();
  gl=setInterval(tick,speed);
  setActive(me,true);refreshStats();
}
function gameOver(){
  clearInterval(gl);running=false;clS();
  // Capture FIRST before any reset
  var finalScore=score;
  var finalLv=lvI+1;
  var fg=calcGrade();
  var gList='';
  for(var i=0;i<grades.length;i++){gList+='LV'+grades[i].lv+':'+grades[i].g+' ';}
  saveBest(me,finalScore);
  setActive(me,false);refreshStats();
  // Show game over with captured values
  showOv('GAME OVER',
    '<div class="ov-grade" style="color:'+gc(fg)+';font-size:22px">GRADE '+fg+'</div>'+
    '<div class="ov-info">SCORE: '+finalScore+' - LV'+finalLv+'</div>'+
    (gList?'<div style="font-size:5px;color:var(--mid);margin-top:3px">'+gList+'</div>':'')+
    '<div class="ov-btns" style="margin-top:6px">'+
    '<button class="ov-btn" id="lbBtn" style="background:#7a4a00">LEADERBOARD</button>'+
    '</div>',
    'PRESS START TO RETRY');
  setTimeout(function(){
    var b=document.getElementById('lbBtn');
    if(b)b.onclick=showLeaderboard;
  },50);
  // Reset AFTER display
  score=0;lvI=0;lv=LVS[0];speed=lv.spd;
  border=0;grades=[];lvF=0;lvD=0;lvG=0;
  shOn=false;ghOn=false;ghMs=0;mN=1;mMs=0;
  updateScore();updateHUD();
}
function togglePause(){
  if(!running||flash)return;
  if(paused){resumeFromPause();return;}
  clearInterval(gl);doSave();paused=true;
  showOv('PAUSED',
    '<div class="ov-btns" style="margin-top:6px;flex-wrap:wrap;gap:5px;justify-content:center">'+
    '<button class="ov-btn" id="rpBtn">RESUME</button>'+
    '<button class="ov-btn" id="ctBtn" style="background:#1a4a9a">CONTROLS</button>'+
    '<button class="ov-btn" id="lbPBtn" style="background:#7a4a00">LEADERBOARD</button>'+
    '</div>','');
  setTimeout(function(){
    var rp=document.getElementById('rpBtn');
    var ct=document.getElementById('ctBtn');
    var lb=document.getElementById('lbPBtn');
    if(rp)rp.onclick=resumeFromPause;
    if(ct)ct.onclick=function(){
      document.getElementById('overlay').classList.add('hidden');
      openSettings();
    };
    if(lb)lb.onclick=showLeaderboard;
  },50);
}
function resumeFromPause(){
  if(!paused)return;
  closeSettings();
  lt=Date.now();gl=setInterval(tick,speed);
  document.getElementById('overlay').classList.add('hidden');
  paused=false;
}
function showOv(t,e,s){
  document.getElementById('ovTitle').innerHTML=t;
  document.getElementById('ovExtra').innerHTML=e;
  document.getElementById('ovSub').innerHTML=s;
  document.getElementById('overlay').classList.remove('hidden');
}
function setDir(dx,dy){
  if(dx!==0&&dir.x===-dx)return;
  if(dy!==0&&dir.y===-dy)return;
  ndir={x:dx,y:dy};
}
function go(dx,dy){if(running)setDir(dx,dy);else startFresh();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLeaderboard(){
  var p=ldP();
  var list=[];
  for(var k in p){if(p.hasOwnProperty(k))list.push(p[k]);}
  list.sort(function(a,b){return (b.best||0)-(a.best||0);});
  var myRank=0;
  for(var ri=0;ri<list.length;ri++){if(list[ri].name===me){myRank=ri+1;break;}}
  var myBest=(p[me]&&p[me].best)||0;
  var reward='NEWBIE';
  if(myBest>=1080)     reward='LEGEND - LV8 MASTER';
  else if(myBest>=840) reward='ELITE - LV7 CLEARED';
  else if(myBest>=630) reward='CHAMPION - LV6';
  else if(myBest>=450) reward='VETERAN - LV5';
  else if(myBest>=300) reward='SKILLED - LV4';
  else if(myBest>=180) reward='RISING - LV3';
  else if(myBest>=80)  reward='ROOKIE - LV2';
  var rows='';
  var now2=Date.now();
  for(var i=0;i<list.length&&i<8;i++){
    var pl=list[i];
    var isMe=(pl.name===me);
    var medal=(i===0)?'1ST':(i===1)?'2ND':(i===2)?'3RD':((i+1)+'TH');
    var dot=pl.active&&(now2-(pl.lastSeen||0)<15000)?' *':'';
    var bg=isMe?'background:rgba(74,144,226,.18);border-radius:3px;':'';
    var nc=isMe?'#ffcc00':'#9bbc0f';
    var sc2=isMe?'#ffcc00':'#ccc';
    rows+='<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 4px;'+bg+'border-bottom:1px solid rgba(155,188,15,.15)">'+
      '<span style="font-size:6px;color:'+nc+'">'+medal+' '+pl.name+dot+'</span>'+
      '<span style="font-size:6.5px;color:'+sc2+'">'+(pl.best||0)+'</span>'+
      '</div>';
  }
  if(!rows)rows='<div style="font-size:5px;color:var(--mid);text-align:center;padding:8px">NO PLAYERS YET</div>';
  showOv('LEADERBOARD',
    '<div style="font-size:5.5px;color:var(--mid);margin-bottom:4px">'+
    'YOUR BEST: <span style="color:#ffcc00">'+myBest+'</span>'+
    '  RANK: <span style="color:#4a90e2">#'+(myRank||'-')+'</span></div>'+
    '<div style="font-size:5.5px;margin-bottom:5px;color:#ffcc00">'+reward+'</div>'+
    '<div style="width:100%;background:rgba(0,0,0,.2);border-radius:4px;padding:4px;max-height:80px;overflow-y:auto">'+
    rows+'</div>'+
    '<div class="ov-btns" style="margin-top:7px">'+
    '<button class="ov-btn" id="lbBack">BACK</button>'+
    '<button class="ov-btn" id="lbPlay" style="background:#0f380f;color:#9bbc0f">PLAY</button>'+
    '</div>','');
  setTimeout(function(){
    var bk=document.getElementById('lbBack');
    var pl=document.getElementById('lbPlay');
    if(bk)bk.onclick=showHome;
    if(pl)pl.onclick=startFresh;
  },50);
}
function showHome(){
  showOv('SNAKE EVO',
    '<div class="ov-btns" style="margin-top:4px;flex-wrap:wrap;justify-content:center;gap:5px">'+
    '<button class="ov-btn" id="lbHBtn" style="background:#7a4a00">LEADERBOARD</button>'+
    '<button class="ov-btn" id="howBtn" style="background:#1a4a9a">HOW TO PLAY</button>'+
    '</div>',
    'PRESS START TO BEGIN');
  setTimeout(function(){
    var b=document.getElementById('lbHBtn');
    var h=document.getElementById('howBtn');
    if(b)b.onclick=showLeaderboard;
    if(h)h.onclick=showIntro;
  },50);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INTRO SLIDESHOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var INTRO_PAGES=[
  '<div class="is-heading">HOW TO PLAY</div>'+
  '<div class="is-row"><span class="is-icon">D</span><span class="is-text">Use the D-PAD to steer your snake. Do not hit walls or yourself!</span></div>'+
  '<div class="is-row"><span class="is-icon">F</span><span class="is-text">Each food = 10 points. Eat more to grow and level up.</span><span class="is-badge" style="background:#0f380f;color:#9bbc0f">+10pts</span></div>'+
  '<div class="is-row"><span class="is-icon">X</span><span class="is-text">Hit a wall or yourself and it is GAME OVER. Score resets to zero.</span></div>'+
  '<div class="is-row"><span class="is-icon">P</span><span class="is-text">Press PAUSE to resume, see leaderboard or change controls.</span></div>',

  '<div class="is-heading">THE 8 LEVELS</div>'+
  '<div style="width:100%;max-height:105px;overflow-y:auto">'+
  '<div class="is-row"><span class="is-icon">1</span><span class="is-text">LV1 Open Field. Slow start. Learn the controls.</span><span class="is-badge" style="background:#0f380f;color:#9bbc0f">0pts</span></div>'+
  '<div class="is-row"><span class="is-icon">2</span><span class="is-text">LV2 Rocks appear. Avoid the grey boulders.</span><span class="is-badge" style="background:#0f380f;color:#9bbc0f">80pts</span></div>'+
  '<div class="is-row"><span class="is-icon">3</span><span class="is-text">LV3 Bush and Golden Prey unlock. 50pt bonus target.</span><span class="is-badge" style="background:#0f380f;color:#9bbc0f">180pts</span></div>'+
  '<div class="is-row"><span class="is-icon">4</span><span class="is-text">LV4 Moving obstacle. Red block bounces around.</span><span class="is-badge" style="background:#0f380f;color:#9bbc0f">300pts</span></div>'+
  '<div class="is-row"><span class="is-icon">5</span><span class="is-text">LV5 Shrinking border. Walls close in every 25 sec.</span><span class="is-badge" style="background:#0f380f;color:#9bbc0f">450pts</span></div>'+
  '<div class="is-row"><span class="is-icon">6</span><span class="is-text">LV6 Power-ups appear. Shield, Ghost and 2x score.</span><span class="is-badge" style="background:#0f380f;color:#9bbc0f">630pts</span></div>'+
  '<div class="is-row"><span class="is-icon">7</span><span class="is-text">LV7 Triple score power-up added.</span><span class="is-badge" style="background:#0f380f;color:#9bbc0f">840pts</span></div>'+
  '<div class="is-row"><span class="is-icon">8</span><span class="is-text">LV8 Survival. Max speed. 4 movers. Full chaos.</span><span class="is-badge" style="background:#0f380f;color:#9bbc0f">1080pts</span></div>'+
  '</div>',

  '<div class="is-heading">GRADE REWARDS</div>'+
  '<div class="is-sub">GRADED EACH LEVEL. DO WELL - GET A BONUS NEXT LEVEL!</div>'+
  '<div class="is-row"><span class="is-icon" style="color:#ffcc00;font-weight:bold">S</span><span class="is-text">No deaths + golden prey + 4 or more food</span><span class="is-badge" style="background:#1a8a1a;color:#fff">GHOST 20s</span></div>'+
  '<div class="is-row"><span class="is-icon" style="color:#8bc34a;font-weight:bold">A</span><span class="is-text">No deaths + 3 or more food eaten this level</span><span class="is-badge" style="background:#4a90e2;color:#fff">SHIELD</span></div>'+
  '<div class="is-row"><span class="is-icon" style="color:#4a90e2;font-weight:bold">B</span><span class="is-text">1 death max + 2 or more food eaten</span><span class="is-badge" style="background:#9966cc;color:#fff">2X SCORE 30s</span></div>'+
  '<div class="is-row"><span class="is-icon" style="color:#ff8800;font-weight:bold">C</span><span class="is-text">2 deaths max. Keep going!</span><span class="is-badge" style="background:#cc7700;color:#fff">+50 PTS</span></div>'+
  '<div class="is-row"><span class="is-icon" style="color:#cc4444;font-weight:bold">D</span><span class="is-text">3 or more deaths. No reward this level.</span><span class="is-badge" style="background:#555;color:#fff">NONE</span></div>',

  '<div class="is-heading">POWER-UPS</div>'+
  '<div class="is-row"><span class="is-icon" style="color:#3399ff;font-weight:bold">S</span><span class="is-text">SHIELD. Survive one wall or self hit. Appears LV6+.</span><span class="is-badge" style="background:#3399ff;color:#fff">1 HIT</span></div>'+
  '<div class="is-row"><span class="is-icon" style="color:#9966cc;font-weight:bold">G</span><span class="is-text">GHOST. Pass through yourself for 5 seconds. LV6+.</span><span class="is-badge" style="background:#9966cc;color:#fff">5s</span></div>'+
  '<div class="is-row"><span class="is-icon" style="color:#ff8800;font-weight:bold">2</span><span class="is-text">2X SCORE. Double all points for 15 seconds. LV6+.</span><span class="is-badge" style="background:#ff8800;color:#fff">x2</span></div>'+
  '<div class="is-row"><span class="is-icon" style="color:#ff4400;font-weight:bold">3</span><span class="is-text">3X SCORE. Triple points for 8 seconds. LV7 only.</span><span class="is-badge" style="background:#ff4400;color:#fff">x3</span></div>'+
  '<div class="is-row"><span class="is-icon" style="color:#cc9900;font-weight:bold">*</span><span class="is-text">GOLDEN PREY. Flashing square worth 50 pts. Grab it fast!</span><span class="is-badge" style="background:#cc9900;color:#fff">50pts</span></div>'+
  '<div class="is-row"><span class="is-icon" style="color:#1a6a1a;font-weight:bold">B</span><span class="is-text">BUSH. Enter it, then find the hidden food for 30 pts.</span><span class="is-badge" style="background:#1a6a1a;color:#fff">30pts</span></div>',

  '<div class="is-heading">RANK TIERS</div>'+
  '<div class="is-sub">YOUR BEST SCORE IS SAVED. CLIMB THE BOARD!</div>'+
  '<div style="width:100%;max-height:105px;overflow-y:auto">'+
  '<div class="is-row"><span class="is-icon">T</span><span class="is-text">LEGEND. Score 1080 or more. LV8 master.</span><span class="is-badge" style="background:#aa7700;color:#fff">1080+</span></div>'+
  '<div class="is-row"><span class="is-icon">E</span><span class="is-text">ELITE. Score 840 or more. LV7 cleared.</span><span class="is-badge" style="background:#7700aa;color:#fff">840+</span></div>'+
  '<div class="is-row"><span class="is-icon">C</span><span class="is-text">CHAMPION. Score 630 or more. LV6 reached.</span><span class="is-badge" style="background:#4a90e2;color:#fff">630+</span></div>'+
  '<div class="is-row"><span class="is-icon">V</span><span class="is-text">VETERAN. Score 450 or more. LV5 reached.</span><span class="is-badge" style="background:#1a8a1a;color:#fff">450+</span></div>'+
  '<div class="is-row"><span class="is-icon">S</span><span class="is-text">SKILLED. Score 300 or more. LV4 reached.</span><span class="is-badge" style="background:#cc5500;color:#fff">300+</span></div>'+
  '<div class="is-row"><span class="is-icon">R</span><span class="is-text">RISING. Score 180 or more. LV3 reached.</span><span class="is-badge" style="background:#306230;color:#9bbc0f">180+</span></div>'+
  '<div class="is-row"><span class="is-icon">K</span><span class="is-text">ROOKIE. Score 80 or more. LV2 reached.</span><span class="is-badge" style="background:#555;color:#fff">80+</span></div>'+
  '<div class="is-row"><span class="is-icon">N</span><span class="is-text">NEWBIE. Just getting started. Keep playing!</span><span class="is-badge" style="background:#444;color:#fff">0+</span></div>'+
  '</div>'
];

var introCurrent=0;

function showIntroPage(n){
  introCurrent=n;
  var content=document.getElementById('introContent');
  if(!content)return;
  content.innerHTML=INTRO_PAGES[n];
  var dots=document.querySelectorAll('.intro-dot');
  for(var i=0;i<dots.length;i++){
    dots[i].className=i===n?'intro-dot on':'intro-dot';
  }
  var prevBtn=document.getElementById('introPrev');
  var nextBtn=document.getElementById('introNext');
  if(prevBtn){prevBtn.style.opacity=n===0?'0.3':'1';prevBtn.disabled=(n===0);}
  if(nextBtn){nextBtn.textContent=n===INTRO_PAGES.length-1?'PLAY!':'NEXT >';}
}
function showIntro(){
  document.getElementById('introOv').classList.remove('hidden');
  document.getElementById('overlay').classList.add('hidden');
  document.getElementById('nameOverlay').classList.add('hidden');
  showIntroPage(0);
}
function closeIntro(){
  document.getElementById('introOv').classList.add('hidden');
  if(!me){ showNameEntry(); } else { showHome(); }
}
document.getElementById('introNext').addEventListener('click',function(){
  if(introCurrent<INTRO_PAGES.length-1){showIntroPage(introCurrent+1);}
  else{closeIntro();}
});
document.getElementById('introPrev').addEventListener('click',function(){
  if(introCurrent>0)showIntroPage(introCurrent-1);
});
document.getElementById('introSkip').addEventListener('click',closeIntro);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',function(e){
  if(!nameOverlay.classList.contains('hidden'))return;
  if(e.key==='ArrowUp')   {e.preventDefault();go(0,-1);}
  else if(e.key==='ArrowDown') {e.preventDefault();go(0,1);}
  else if(e.key==='ArrowLeft') {e.preventDefault();go(-1,0);}
  else if(e.key==='ArrowRight'){e.preventDefault();go(1,0);}
  else if(e.key==='Enter'||e.key===' '){e.preventDefault();startFresh();}
  else if(e.key==='p'||e.key==='P'){togglePause();}
});

// BUTTONS
document.getElementById('btnUp').addEventListener('click',    function(){go(0,-1);});
document.getElementById('btnDown').addEventListener('click',  function(){go(0,1);});
document.getElementById('btnLeft').addEventListener('click',  function(){go(-1,0);});
document.getElementById('btnRight').addEventListener('click', function(){go(1,0);});
document.getElementById('btnCenter').addEventListener('click',function(){
  if(!nameOverlay.classList.contains('hidden')){confirmName();return;}
  startFresh();
});
document.getElementById('btnStart').addEventListener('click', startFresh);
document.getElementById('btnPause').addEventListener('click', togglePause);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadCtrlSettings();
applyCtrl();
ctx.fillStyle='#9bbc0f';
ctx.fillRect(0,0,canvas.width,canvas.height);
refreshStats();
setInterval(function(){if(!running)draw();},300);
// Small delay so font loads before showing anything
setTimeout(function(){ showIntro(); }, 200);
</script>

</body>
</html>
